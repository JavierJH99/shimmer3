#!/usr/bin/python
import sys, struct, serial

def wait_for_ack():
   ddata = ""
   ack = struct.pack('B', 0xff)
   while ddata != ack:
      ddata = ser.read(1)
   return

if len(sys.argv) < 3:
   print "no device specified"
   print "You need to specify the serial port of the device you wish to connect to"
   print "followed by which sensor's calibration values you wish to write, as"
   print "specified from the following list"
   print "   0: Reset all calibration values"
   print "   1: Analog Accel"
   print "   2: Gyro"
   print "   3: Magnetometer"
   print "   4: Digital Accel (LSM303DLHC)"
   print "example:"
   print "   calWrite.py Com12 3"
   print "or"
   print "   calWrite.py /dev/rfcomm0 1"
else:
   selection = int(sys.argv[2])
   if (selection<0) or (selection>4):
      print "Invalid selection\nExiting..."
      sys.exit()

   ser = serial.Serial(sys.argv[1], 115200)
   ser.flushInput()
   if sys.argv[2] == '0':
      print "Resetting all calibration values"
# send the reset calibration values command
      ser.write(struct.pack('B', 0x5B))
   elif sys.argv[2] == '1':
      print "Setting analog accel calibration values to: 0x11 0x22 0x22 0x22 0x22 0x22 0x22 0x22 0x22 0x22 0x22 0x22 0x22 0x22 0x22 0x22 0x22 0x22 0x22 0x22 0x33"
# send the set aAccel calibration command 
      ser.write(struct.pack('BBBBBBBBBBBBBBBBBBBBBB', 0x11, 0x11,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x33))
   elif sys.argv[2] == '2':
      print "Setting gyro calibration values to: 0x44 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x55 0x66"
# send the set gyro calibration command 
      ser.write(struct.pack('BBBBBBBBBBBBBBBBBBBBBB', 0x14, 0x44,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x55,0x66))
   elif sys.argv[2] == '3':
      print "Setting mag calibration values to: 0x77 0x88 0x88 0x88 0x88 0x88 0x88 0x88 0x88 0x88 0x88 0x88 0x88 0x88 0x88 0x88 0x88 0x88 0x88 0x88 0x99"
# send the set mag calibration command 
      ser.write(struct.pack('BBBBBBBBBBBBBBBBBBBBBB', 0x17, 0x77,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x88,0x99))
   elif sys.argv[2] == '4':
      print "Setting digital accel calibration values to: 0xAA 0xBB 0xBB 0xBB 0xBB 0xBB 0xBB 0xBB 0xBB 0xBB 0xBB 0xBB 0xBB 0xBB 0xBB 0xBB 0xBB 0xBB 0xBB 0xBB 0xCC"
# send the set dAccel calibration command 
      ser.write(struct.pack('BBBBBBBBBBBBBBBBBBBBBB', 0x1A, 0xAA,0xBB,0xBB,0xBB,0xBB,0xBB,0xBB,0xBB,0xBB,0xBB,0xBB,0xBB,0xBB,0xBB,0xBB,0xBB,0xBB,0xBB,0xBB,0xBB,0xCC))
   else:
      print "Invalid selection\nExiting..."
      ser.close()
      sys.exit()

   wait_for_ack()
#close serial port
   ser.close()
   print "Ack received"
   print "All done"
